# InstagramæŠ¥å‘ŠçŠ¶æ€é—®é¢˜åˆ†æä¸ä¿®å¤

## ğŸ” é—®é¢˜æè¿°

InstagramæŠ¥å‘Šå‡ºç°äº†çŠ¶æ€ä¸ä¸€è‡´çš„é—®é¢˜ï¼š
- `scraping_sessions` çŠ¶æ€ï¼šâœ… `completed`
- `analysis_tasks` çŠ¶æ€ï¼šâœ… 15ä¸ªå…¨éƒ¨ `completed`
- `reports` çŠ¶æ€ï¼šâŒ `failed` (é”™è¯¯ä¿¡æ¯ï¼š"å¯åŠ¨ç¬¬ä¸€æ‰¹å¤„ç†å¤±è´¥")

## ğŸ•µï¸ æ ¹æœ¬åŸå› åˆ†æ

### é—®é¢˜æµç¨‹
1. **start-analysis-v2** å‡½æ•°æˆåŠŸåˆ›å»ºäº†15ä¸ªåˆ†æä»»åŠ¡
2. è°ƒç”¨ **startFirstBatch** å¯åŠ¨ç¬¬ä¸€æ‰¹å¤„ç†æ—¶ï¼ŒHTTPè°ƒç”¨å¯èƒ½å› ä¸ºè¶…æ—¶æˆ–ç½‘ç»œé—®é¢˜è¿”å›å¤±è´¥
3. å‡½æ•°ç«‹å³å°†æŠ¥å‘ŠçŠ¶æ€è®¾ç½®ä¸º `failed`ï¼Œé”™è¯¯ä¿¡æ¯ä¸º"å¯åŠ¨ç¬¬ä¸€æ‰¹å¤„ç†å¤±è´¥"
4. ä½†å®é™…ä¸Šï¼Œåˆ†æä»»åŠ¡å·²ç»è¢«åˆ›å»ºå¹¶å¼€å§‹å¤„ç†
5. åç»­é€šè¿‡ **cron-batch-processor** ç»§ç»­å¤„ç†æ‰€æœ‰æ‰¹æ¬¡
6. æ‰€æœ‰15ä¸ªä»»åŠ¡éƒ½æˆåŠŸå®Œæˆï¼Œä½†æŠ¥å‘ŠçŠ¶æ€ä»ç„¶æ˜¯ `failed`
7. **complete-report-analysis** ä»æœªè¢«è°ƒç”¨ï¼Œå› ä¸ºæŠ¥å‘ŠçŠ¶æ€ä¸æ˜¯ `analyzing`

### ä»£ç é—®é¢˜ä½ç½®
åœ¨ `supabase/functions/start-analysis-v2/index.ts` ç¬¬522-539è¡Œï¼š

```typescript
if (!startSuccess) {
  // å¦‚æœç¬¬ä¸€æ‰¹å¯åŠ¨å¤±è´¥ï¼Œå°†æŠ¥å‘ŠçŠ¶æ€æ”¹ä¸ºfailed
  await supabase
    .from('reports')
    .update({
      status: 'failed',
      failure_stage: 'analysis',
      error_message: 'å¯åŠ¨ç¬¬ä¸€æ‰¹å¤„ç†å¤±è´¥',
      // ...
    })
    .eq('id', reportId);
    
  throw new Error('å¯åŠ¨ç¬¬ä¸€æ‰¹å¤„ç†å¤±è´¥');
}
```

## ğŸ› ï¸ è§£å†³æ–¹æ¡ˆ

### 1. ç«‹å³ä¿®å¤ âœ…
- æ‰‹åŠ¨å°†æŠ¥å‘ŠçŠ¶æ€æ”¹ä¸º `analyzing`
- è°ƒç”¨ `complete-report-analysis` å®ŒæˆæŠ¥å‘Š
- æ¸…ç†é”™è¯¯ä¿¡æ¯
- **ç»“æœ**ï¼šInstagramæŠ¥å‘Šç°åœ¨çŠ¶æ€ä¸º `completed`ï¼ŒåŒ…å«132ä¸ªä¸»é¢˜

### 2. åˆ›å»ºä¿®å¤å·¥å…· âœ…
åˆ›å»ºäº† `fix-orphaned-reports` Edge Functionï¼š
- è‡ªåŠ¨æ£€æµ‹æ‰€æœ‰analysis_taskså®Œæˆä½†reportçŠ¶æ€ä¸ºfailedçš„æƒ…å†µ
- è‡ªåŠ¨è°ƒç”¨complete-report-analysisä¿®å¤çŠ¶æ€
- æä¾›è¯¦ç»†çš„ä¿®å¤æŠ¥å‘Š

### 3. æ”¹è¿›ä»£ç é€»è¾‘ âœ…
ä¿®æ”¹äº† `start-analysis-v2` çš„é”™è¯¯å¤„ç†ï¼š
- ä¸å†åœ¨ç¬¬ä¸€æ‰¹å¯åŠ¨å¤±è´¥æ—¶ç«‹å³è®¾ç½®ä¸ºfailed
- è®©cronä»»åŠ¡ç»§ç»­ç›‘æ§å’Œå¤„ç†
- é¿å…çŠ¶æ€ä¸ä¸€è‡´é—®é¢˜

## ğŸ“Š ä¿®å¤ç»“æœ

### InstagramæŠ¥å‘ŠçŠ¶æ€
- **æŠ¥å‘ŠID**: `5ce5f313-015c-44b6-a227-ecd1031fbae9`
- **çŠ¶æ€**: `completed` âœ…
- **å®Œæˆæ—¶é—´**: `2025-06-25 19:13:03.634+00`
- **ä¸»é¢˜æ•°é‡**: 132ä¸ª
- **é”™è¯¯ä¿¡æ¯**: å·²æ¸…ç† âœ…

### ç³»ç»Ÿæ”¹è¿›
1. **é˜²æ­¢é—®é¢˜å†æ¬¡å‘ç”Ÿ**: ä¿®æ”¹äº†start-analysis-v2çš„é”™è¯¯å¤„ç†é€»è¾‘
2. **è‡ªåŠ¨ä¿®å¤å·¥å…·**: éƒ¨ç½²äº†fix-orphaned-reportså‡½æ•°
3. **ç›‘æ§èƒ½åŠ›**: å¯ä»¥å®šæœŸè¿è¡Œä¿®å¤å·¥å…·æ£€æŸ¥ç±»ä¼¼é—®é¢˜

## ğŸ”§ ä½¿ç”¨ä¿®å¤å·¥å…·

å¦‚æœå°†æ¥å†æ¬¡é‡åˆ°ç±»ä¼¼é—®é¢˜ï¼Œå¯ä»¥è°ƒç”¨ä¿®å¤å‡½æ•°ï¼š

```bash
curl -X POST https://mihmdokivbllrcrjoojo.supabase.co/functions/v1/fix-orphaned-reports \
  -H "Authorization: Bearer YOUR_KEY" \
  -H "Content-Type: application/json"
```

## ğŸ“ é¢„é˜²æªæ–½

1. **ç›‘æ§æŠ¥å‘ŠçŠ¶æ€**: å®šæœŸæ£€æŸ¥æ˜¯å¦æœ‰çŠ¶æ€ä¸ä¸€è‡´çš„æŠ¥å‘Š
2. **æ”¹è¿›é”™è¯¯å¤„ç†**: ä¸è¦åœ¨HTTPè°ƒç”¨å¤±è´¥æ—¶ç«‹å³è®¾ç½®ä¸ºfailed
3. **å¢å¼ºæ—¥å¿—è®°å½•**: è®°å½•æ›´è¯¦ç»†çš„çŠ¶æ€è½¬æ¢æ—¥å¿—
4. **å®šæœŸè¿è¡Œä¿®å¤**: å¯ä»¥å°†fix-orphaned-reportsåŠ å…¥å®šæ—¶ä»»åŠ¡

## âœ… æ€»ç»“

é—®é¢˜å·²å®Œå…¨è§£å†³ï¼š
- InstagramæŠ¥å‘ŠçŠ¶æ€å·²ä¿®å¤ä¸ºcompleted
- åˆ›å»ºäº†è‡ªåŠ¨ä¿®å¤å·¥å…·é˜²æ­¢ç±»ä¼¼é—®é¢˜
- æ”¹è¿›äº†ä»£ç é€»è¾‘é¿å…çŠ¶æ€ä¸ä¸€è‡´
- ç³»ç»Ÿç°åœ¨æ›´åŠ å¥å£®å’Œå¯é 
